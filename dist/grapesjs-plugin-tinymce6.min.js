/*! grapesjs-plugin-tinymce6 - 0.1.2 */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports["grapesjs-plugin-tinymce6"]=e():t["grapesjs-plugin-tinymce6"]=e()}("undefined"!=typeof self?self:this,function(){return function(t){function e(o){if(n[o])return n[o].exports;var i=n[o]={i:o,l:!1,exports:{}};return t[o].call(i.exports,i,i.exports,e),i.l=!0,i.exports}var n={};return e.m=t,e.c=n,e.d=function(t,n,o){e.o(t,n)||Object.defineProperty(t,n,{configurable:!1,enumerable:!0,get:o})},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=0)}([function(t,e,n){"use strict";function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e,n){var o=document.createElement(t);return r(o,n),e&&e.appendChild(o),o}function r(t,e){if(e)for(var n in e)"object"===c(e[n])?r(t[n],e[n]):t[n]=e[n]}function a(){window.grapesjsTinyDocsData={editorClickHandler:function(t){13!==t.keyCode||t.shiftKey||(t.stopPropagation(),t.preventDefault(),t.stopImmediatePropagation(),window.grapesjsTinyDocsData.editorInstance.fire("keydown",{keyCode:13,shiftKey:!0}))}}}function s(t,e){function n(){var t=window.grapesjsTinyDocsData.latestClickEvent;if(t){var e=null,n=void 0,o=void 0;if(document.caretRangeFromPoint?(e=document.caretRangeFromPoint(t.clientX,t.clientY),n=e.startContainer,o=e.startOffset):document.caretPositionFromPoint&&(e=document.caretPositionFromPoint(t.clientX,t.clientY),n=e.offsetNode,o=e.offset),e){e=document.createRange();var i=document.getSelection();e.setStart(n,o),e.collapse(!0),i.removeAllRanges(),i.addRange(e)}window.grapesjsTinyDocsData.latestClickEvent=null}}function o(t,e,n){var o=document.createElement(t);return i(o,n),e&&e.appendChild(o),o}function i(t,e){if(e)for(var n in e)"object"===_typeof(e[n])?i(t[n],e[n]):t[n]=e[n]}var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=JSON.parse(decodeURI(e));window.grapesjsTinyDocsData.toolbarContainer=o("div",document.body,{style:{position:"absolute",top:"0px",bottom:"0px",height:"min-content"}}),window.grapesjsTinyDocsData.toolbarContainer.addEventListener("mousedown",function(t){t.stopPropagation(),t.stopImmediatePropagation()}),window.grapesjsTinyDocsData.editedEl=document.body.querySelector(t),window.grapesjsTinyDocsData.forceBr=r,r&&window.grapesjsTinyDocsData.editedEl.addEventListener("keydown",window.grapesjsTinyDocsData.editorClickHandler),tinymce.init({selector:t,inline:!0,menubar:!1,newline_behavior:"default",plugins:a.plugins,toolbar:a.toolbar,fixed_toolbar_container_target:o("div",window.grapesjsTinyDocsData.toolbarContainer,{}),init_instance_callback:function(t){window.grapesjsTinyDocsData.editorInstance=t}}).then(function(t){window.grapesjsTinyDocsData.tinymceInstant=t[0],setTimeout(function(){t[0].focus(),n()})})}Object.defineProperty(e,"__esModule",{value:!0});var c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},l=function(){function t(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,n,o){return n&&t(e.prototype,n),o&&t(e,o),e}}();e.default=function(t,e){new u(t,e)};var u=function(){function t(e,n){var i=this;o(this,t),this.injectEditorModule(n["tinymce-module"]),this._TinyForGrapesJsData={editor:e,el:null,frame:null,toolBarMObserver:new MutationObserver(this.onResize.bind(this)),elementObserver:new MutationObserver(function(){i.onResize(),i.editor.refresh()}),editorOptions:n},e.RichTextEditor.getAll().map(function(t){return t.name}).forEach(function(t){return e.RichTextEditor.remove(t)}),e.on("frame:load:before",function(t){var e=t.el,n=e.contentDocument;n.doctype&&"html"===n.doctype.nodeName.toLowerCase()||(n.open(),n.write("<!DOCTYPE html>"),n.close())}),e.on("frame:load",function(t){var e=t.el;t.model,t.view;i.frame=e,i.frameBody.addEventListener("mousedown",function(t){return i.latestClickEvent=t})}),e.setCustomRte({enable:this.enable.bind(this),disable:this.disable.bind(this)})}return l(t,[{key:"injectEditorModule",value:function(t){var e=this;setTimeout(function(){var n=e.frameBody;n&&""!==n.innerHTML?(i("script",n,{src:t}),i("script",n,{innerHTML:s.toString()+"; function _typeof(obj) { return typeof obj; }"}),e.executeInFrame("("+a.toString()+")()"),e.frameContext.addEventListener("scroll",e.onResize.bind(e)),e.frameContext.addEventListener("resize",e.onResize.bind(e))):e.injectEditorModule(t)},100)}},{key:"getElementId",value:function(t){return t.id=""===t.id||null===t.id||void 0===t.id?"tinymce_target_el_"+this.uniqId:t.id}},{key:"enable",value:function(t,e){var n=this;setTimeout(function(){return o(t,e)});var o=function(t,e){n.el=t;var o=t,r=n.editorOptions,a="false";if(Array.isArray(r.inline)&&r.inline.includes(t.tagName.toLowerCase()))r={toolbar:r.inline_toolbar||r.toolbar,plugins:r.plugins},a="true";else{var c=t.innerHTML;t.innerHTML="",o=i("div",t,{innerHTML:c,style:{outline:"none"}}),r={toolbar:r.toolbar,plugins:r.plugins}}return n.executeInFrame(s.name+"('#"+n.getElementId(o)+"',\""+encodeURI(JSON.stringify(r))+'",'+a+");"),setTimeout(function(){n.toolBarMObserver.observe(n.toolbarContainer.firstChild,{subtree:!0,childList:!0,attributes:!0}),n.elementObserver.observe(n.el,{subtree:!0,childList:!0,attributes:!0}),n.onResize()}),n}}},{key:"getContent",value:function(){return this.tinymceInstant?this.tinymceInstant.bodyElement.innerHTML:""}},{key:"disable",value:function(t,e){var n=this;this.el&&(this.el.innerHTML=this.getContent()),this.el=null,this.toolBarMObserver.disconnect(),this.elementObserver.disconnect(),setTimeout(function(){n.executeInFrame("if (window.grapesjsTinyDocsData.tinymceInstant) {window.grapesjsTinyDocsData.tinymceInstant.destroy();window.grapesjsTinyDocsData.toolbarContainer.remove();window.grapesjsTinyDocsData.tinymceInstant=null;window.grapesjsTinyDocsData.forceBr && window.grapesjsTinyDocsData.editedEl.removeEventListener('keydown',window.grapesjsTinyDocsData.editorClickHandler);}")})}},{key:"executeInFrame",value:function(t){i("script",this.frameBody,{innerHTML:t}).remove()}},{key:"positionToolbar",value:function(){if(this.toolbarContainer.firstChild.firstChild){this.toolbarContainer.style.display="",this.toolbarContainer.style.top="0px",this.toolbarContainer.style.left="0px";var t=this.editor.RichTextEditor.getToolbarEl(),e=t.parentElement.querySelector(".gjs-toolbar"),n=e&&e.getBoundingClientRect()||{width:0,height:0,bottom:0},o=this.toolbarContainer.getBoundingClientRect(),i=this.el.getBoundingClientRect(),r=void 0,a=void 0,s=o.width>i.width-n.width-1;s?(r=i.left-(o.width-i.width)/2+this.frameScrollX,r+o.width>this.frameBody.offsetWidth&&(r-=r+o.width-this.frameBody.offsetWidth+5),r<this.frameScrollX&&(r=this.frameScrollX)):r=i.left+this.frameScrollX,this.toolbarContainer.style.left=r+"px",o=this.toolbarContainer.getBoundingClientRect(),a=i.top+this.frameScrollY-o.height-1-(s?n.height:0),a<=this.frameScrollY&&(a=i.bottom+this.frameScrollY+1+(s&&n.bottom>i.bottom?n.height:0)),this.toolbarContainer.style.top=a+"px"}else this.toolbarContainer.style.display="none"}},{key:"onResize",value:function(){var t=this;this.isActive&&setTimeout(function(){t.positionToolbar()})}},{key:"frame",get:function(){return this._TinyForGrapesJsData.frame},set:function(t){this._TinyForGrapesJsData.frame=t}},{key:"latestClickEvent",set:function(t){this.grapesjsTinyDocsData&&(this.grapesjsTinyDocsData.latestClickEvent=t)}},{key:"editorOptions",get:function(){return this._TinyForGrapesJsData.editorOptions}},{key:"toolBarMObserver",get:function(){return this._TinyForGrapesJsData.toolBarMObserver}},{key:"elementObserver",get:function(){return this._TinyForGrapesJsData.elementObserver}},{key:"editor",get:function(){return this._TinyForGrapesJsData.editor}},{key:"el",get:function(){return this._TinyForGrapesJsData.el},set:function(t){this._TinyForGrapesJsData.el=t}},{key:"uniqId",get:function(){return t.constructor.uniqId++}},{key:"frameDocument",get:function(){var t=this.frame;return t&&t.contentDocument}},{key:"frameBody",get:function(){var t=this.frameDocument;return t&&t.querySelector("body")}},{key:"frameContext",get:function(){var t=this.frame;return t&&t.contentWindow}},{key:"grapesjsTinyDocsData",get:function(){return this.frameContext&&this.frameContext.grapesjsTinyDocsData},set:function(t){this.frameContext&&(this.frameContext.grapesjsTinyDocsData=t)}},{key:"tinymceInstant",get:function(){return this.grapesjsTinyDocsData&&this.grapesjsTinyDocsData.tinymceInstant}},{key:"toolbarContainer",get:function(){return this.grapesjsTinyDocsData&&this.grapesjsTinyDocsData.toolbarContainer}},{key:"frameScrollY",get:function(){return this.frameContext?this.frameContext.scrollY:0}},{key:"frameScrollX",get:function(){return this.frameContext?this.frameContext.scrollX:0}},{key:"isActive",get:function(){return null!==this.el}}]),t}();u.constructor.uniqId=0}])});